<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receipt Parser</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #818cf8;
            --success-color: #22c55e;
            --background-color: #f8fafc;
            --card-background: #ffffff;
            --text-color: #1e293b;
            --border-color: #e2e8f0;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            line-height: 1.6;
        }

        .navbar {
            background-color: var(--card-background);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1rem 0;
        }

        .navbar-brand {
            font-weight: 600;
            color: var(--primary-color);
        }

        .card {
            background-color: var(--card-background);
            border: none;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s ease-in-out;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card-header {
            background-color: transparent;
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem;
        }

        .card-body {
            padding: 1.5rem;
        }

        .file-upload-container {
            border: 2px dashed var(--border-color);
            border-radius: 1rem;
            padding: 2.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: var(--background-color);
            position: relative;
            overflow: hidden;
        }

        .file-upload-container:hover {
            border-color: var(--primary-color);
            background-color: rgba(79, 70, 229, 0.05);
            transform: translateY(-2px);
        }

        .file-upload-container.dragging {
            border-color: var(--success-color);
            background-color: rgba(34, 197, 94, 0.05);
            transform: scale(1.02);
        }

        .file-upload-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(79, 70, 229, 0.05);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .file-upload-container:hover::after {
            opacity: 1;
        }

        .file-upload-container input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
            z-index: 2;
        }

        .file-upload-container input[type="file"]:focus {
            outline: none;
        }

        .file-upload-container input[type="file"]::-webkit-file-upload-button {
            visibility: hidden;
        }

        .file-upload-container input[type="file"]::file-selector-button {
            visibility: hidden;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
            transform: translateY(-1px);
        }

        .json-display {
            background-color: #1e1e1e;
            color: #d4d4d4;
            border-radius: 1rem;
            font-family: 'Fira Code', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            padding: 1.5rem;
            max-height: 600px;
            overflow-y: auto;
        }

        .user-card {
            transition: all 0.3s ease;
        }

        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px -1px rgba(0, 0, 0, 0.1);
        }

        .avatar-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-color);
            color: white;
        }

        .loading-spinner {
            color: var(--primary-color);
        }

        .alert {
            border-radius: 1rem;
            border: none;
        }

        .form-control {
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(79, 70, 229, 0.25);
        }

        .badge {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .card {
                margin-bottom: 1.5rem;
            }
            
            .file-upload-container {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-receipt me-2"></i>
                Receipt Parser
            </a>
            <div class="d-flex">
                <a href="/analytics" class="btn btn-outline-primary">
                    <i class="fas fa-chart-line me-2"></i>
                    Analytics
                </a>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        <div class="row g-4">
            <!-- Upload Section -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-file-pdf me-2 text-primary"></i>
                            Upload Receipt
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="upload-form" enctype="multipart/form-data">
                            <div id="drop-area" class="file-upload-container mb-4">
                                <input type="file" id="file-input" name="file" accept=".pdf">
                                <div id="file-info" class="hidden">
                                    <p id="file-name" class="h5 mb-1"></p>
                                    <small id="file-size" class="text-muted"></small>
                                </div>
                                <div id="upload-prompt">
                                    <i class="fas fa-file-pdf fa-3x mb-3 text-primary"></i>
                                    <p class="h5 mb-2">Drag & Drop PDF here</p>
                                    <p class="text-muted mb-0">or click to browse</p>
                                </div>
                            </div>
                            
                            <div class="d-flex gap-2">
                                <button type="submit" id="parse-button" class="btn btn-primary flex-grow-1">
                                    <i class="fas fa-magic me-2"></i>Parse Receipt
                                </button>
                                <button type="button" id="save-btn" class="btn btn-success" style="display: none;">
                                    <i class="fas fa-save me-2"></i>Save
                                </button>
                                <button type="button" id="share-btn" class="btn btn-outline-primary" style="display: none;">
                                    <i class="fas fa-share-alt me-2"></i>Share
                                </button>
                                <button type="button" id="clear-button" class="btn btn-outline-secondary">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Results Section -->
            <div class="col-12">
                <div id="result-container-wrapper" class="hidden">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-list me-2 text-primary"></i>
                                Parsed Items
                            </h5>
                            <button id="copy-button" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-copy me-1"></i>Copy
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div id="error-alert" class="alert alert-danger m-3 hidden"></div>
                            
                            <div id="item-view" class="p-4">
                                <!-- Roommate Assignment Section -->
                                <div class="mb-4">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="mb-0">Roommate Assignment</h6>
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-outline-primary" id="assign-all-btn">
                                                <i class="fas fa-users me-1"></i>Assign All
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="clear-assignments-btn">
                                                <i class="fas fa-eraser me-1"></i>Clear All
                                            </button>
                                        </div>
                                    </div>
                                    <div class="row g-3 mb-4">
                                        <div class="col-md-3">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input" type="checkbox" id="roommate1-check" checked>
                                                        <label class="form-check-label" for="roommate1-check">
                                                            <input type="text" class="form-control form-control-sm" id="roommate1-name" placeholder="Roommate 1" value="Roommate 1">
                                                        </label>
                                                    </div>
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <small class="text-muted">Total:</small>
                                                        <span class="h5 mb-0 text-primary" id="roommate1-total">$0.00</span>
                                                    </div>
                                                    <div class="mt-2">
                                                        <small class="text-muted" id="roommate1-items">No items assigned</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input" type="checkbox" id="roommate2-check" checked>
                                                        <label class="form-check-label" for="roommate2-check">
                                                            <input type="text" class="form-control form-control-sm" id="roommate2-name" placeholder="Roommate 2" value="Roommate 2">
                                                        </label>
                                                    </div>
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <small class="text-muted">Total:</small>
                                                        <span class="h5 mb-0 text-success" id="roommate2-total">$0.00</span>
                                                    </div>
                                                    <div class="mt-2">
                                                        <small class="text-muted" id="roommate2-items">No items assigned</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input" type="checkbox" id="roommate3-check" checked>
                                                        <label class="form-check-label" for="roommate3-check">
                                                            <input type="text" class="form-control form-control-sm" id="roommate3-name" placeholder="Roommate 3" value="Roommate 3">
                                                        </label>
                                                    </div>
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <small class="text-muted">Total:</small>
                                                        <span class="h5 mb-0 text-warning" id="roommate3-total">$0.00</span>
                                                    </div>
                                                    <div class="mt-2">
                                                        <small class="text-muted" id="roommate3-items">No items assigned</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input" type="checkbox" id="roommate4-check" checked>
                                                        <label class="form-check-label" for="roommate4-check">
                                                            <input type="text" class="form-control form-control-sm" id="roommate4-name" placeholder="Roommate 4" value="Roommate 4">
                                                        </label>
                                                    </div>
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <small class="text-muted">Total:</small>
                                                        <span class="h5 mb-0 text-info" id="roommate4-total">$0.00</span>
                                                    </div>
                                                    <div class="mt-2">
                                                        <small class="text-muted" id="roommate4-items">No items assigned</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Items List -->
                                <div class="items-list">
                                    <!-- Items will be dynamically added here -->
                                </div>
                                
                                <!-- Cost Summary -->
                                <div class="mt-4 pt-3 border-top">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="mb-0">Cost Summary</h6>
                                        <button type="button" class="btn btn-sm btn-primary" id="calculate-shares-btn">
                                            <i class="fas fa-calculator me-1"></i>Calculate Shares
                                        </button>
                                    </div>
                                    <div id="cost-summary" class="d-none">
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Roommate</th>
                                                        <th class="text-end">Total</th>
                                                        <th>Items</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="cost-summary-list">
                                                    <!-- Cost summary will be dynamically added here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">Total Amount</h6>
                                        <div class="h3 text-primary mb-0" id="total-amount">$0.00</div>
                                    </div>
                                </div>

                                <!-- Distribution Summary -->
                                <div class="distribution-summary">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5 class="mb-0">Distribution Summary</h5>
                                        <div>
                                            <button id="share-btn" class="btn btn-outline-primary btn-sm me-2" style="display: none;">
                                                <i class="fas fa-share-alt"></i> Share
                                            </button>
                                            <button id="save-btn" class="btn btn-primary btn-sm" style="display: none;">
                                                <i class="fas fa-save"></i> Save
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            
            // Get all required elements first
            const fileInput = document.getElementById('file-input');
            const dropArea = document.getElementById('drop-area');
            const fileInfo = document.getElementById('file-info');
            const fileName = document.getElementById('file-name');
            const fileSize = document.getElementById('file-size');
            const uploadPrompt = document.getElementById('upload-prompt');
            const uploadForm = document.getElementById('upload-form');
            const parseButton = document.getElementById('parse-button');
            const clearButton = document.getElementById('clear-button');
            const copyButton = document.getElementById('copy-button');
            const resultContainerWrapper = document.getElementById('result-container-wrapper');
            const errorAlert = document.getElementById('error-alert');
            const itemsList = document.querySelector('.items-list');
            const totalAmount = document.getElementById('total-amount');
            const calculateBtn = document.getElementById('calculate-shares-btn');
            
            console.log('Elements found:', {
                fileInput: !!fileInput,
                dropArea: !!dropArea,
                fileInfo: !!fileInfo,
                fileName: !!fileName,
                fileSize: !!fileSize,
                uploadPrompt: !!uploadPrompt,
                uploadForm: !!uploadForm,
                parseButton: !!parseButton,
                clearButton: !!clearButton,
                copyButton: !!copyButton,
                resultContainerWrapper: !!resultContainerWrapper,
                errorAlert: !!errorAlert,
                itemsList: !!itemsList,
                totalAmount: !!totalAmount,
                calculateBtn: !!calculateBtn
            });

            // Check if required elements exist
            if (!fileInput || !dropArea || !fileInfo || !fileName || !fileSize || !uploadPrompt || !uploadForm) {
                console.error('Required elements not found');
                return;
            }

            // Make the entire drop area clickable
            dropArea.style.cursor = 'pointer';
            
            // File input change event
            fileInput.addEventListener('change', function(e) {
                console.log('File input changed:', e);
                if (this.files && this.files[0]) {
                    console.log('File selected:', this.files[0].name);
                    handleFileSelection(this.files[0]);
                }
            });
            
            // Click event for the drop area
            dropArea.addEventListener('click', function(e) {
                console.log('Drop area clicked');
                e.preventDefault();
                e.stopPropagation();
                console.log('Triggering file input click');
                fileInput.click();
            });
            
            // Direct click on file input
            fileInput.addEventListener('click', function(e) {
                console.log('File input clicked directly');
                e.stopPropagation(); // Prevent event bubbling
            });
            
            // Prevent clicks on the file input from triggering the drop area click
            fileInput.addEventListener('mousedown', function(e) {
                e.stopPropagation();
            });
            
            // Drag and drop events
            dropArea.addEventListener('dragover', function(e) {
                console.log('File dragged over');
                e.preventDefault();
                e.stopPropagation();
                this.classList.add('dragging');
            });
            
            dropArea.addEventListener('dragleave', function(e) {
                console.log('File drag left');
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('dragging');
            });
            
            dropArea.addEventListener('drop', function(e) {
                console.log('File dropped');
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('dragging');
                
                const file = e.dataTransfer.files[0];
                if (file && file.type === 'application/pdf') {
                    console.log('PDF file dropped:', file.name);
                    handleFileSelection(file);
                } else {
                    console.log('Invalid file type dropped');
                    showError('Please select a valid PDF file');
                }
            });
            
            // Form submission
            uploadForm.addEventListener('submit', function(e) {
                console.log('Form submitted');
                e.preventDefault();
                
                if (!fileInput.files[0]) {
                    console.log('No file selected for submission');
                    showError('Please select a PDF file first');
                    return;
                }
                
                console.log('Starting receipt parsing');
                parseReceipt();
            });
            
            // Clear button click
            if (clearButton) {
                clearButton.addEventListener('click', function() {
                    console.log('Clear button clicked');
                    clearAll();
                });
            }
            
            // Calculate shares button click
            if (calculateBtn) {
                calculateBtn.addEventListener('click', function() {
                    console.log('Calculate shares button clicked');
                    calculateCostShares();
                });
            }
            
            // Copy button click
            if (copyButton) {
                copyButton.addEventListener('click', function() {
                    console.log('Copy button clicked');
                    copyJsonToClipboard();
                });
            }
            
            function handleFileSelection(file) {
                console.log('Handling file selection:', file.name);
                if (!file) {
                    console.log('No file provided');
                    return;
                }
                
                if (file.type !== 'application/pdf') {
                    console.log('Invalid file type:', file.type);
                    showError('Please select a valid PDF file');
                    return;
                }
                
                // Display file info
                fileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                
                fileInfo.classList.remove('hidden');
                uploadPrompt.classList.add('hidden');
                hideError();
                
                console.log('File info displayed');
            }
            
            function formatFileSize(bytes) {
                if (bytes < 1024) return bytes + ' bytes';
                else if (bytes < 1048576) return (bytes / 1024).toFixed(2) + ' KB';
                else return (bytes / 1048576).toFixed(2) + ' MB';
            }
            
            async function parseReceipt() {
                const formData = new FormData();
                const file = fileInput.files[0];
                
                if (!file) {
                    showError('Please select a PDF file first');
                    return;
                }
                
                formData.append('file', file);
                
                try {
                    const response = await fetch('/api/upload_pdf', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    if (data) {
                        // Show the save button after successful parsing
                        document.getElementById('save-btn').style.display = 'inline-block';
                        
                        // Show the result container
                        resultContainerWrapper.classList.remove('hidden');
                        
                        // Clear existing items
                        itemsList.innerHTML = '';
                        
                        // Process items and update UI
                        if (data.items && Array.isArray(data.items)) {
                            data.items.forEach((item, index) => {
                                const price = parseFloat(item.price);
                                
                                const row = document.createElement('div');
                                row.className = 'item-row mb-3 p-3 bg-light rounded';
                                row.dataset.index = index;
                                row.dataset.price = price;
                                row.dataset.name = item.name;
                                
                                // Determine item category for icon
                                let itemCategory = 'other';
                                let itemIcon = 'fa-shopping-basket';
                                
                                // Simple category detection based on item name
                                if (item.name.toLowerCase().includes('milk') || 
                                    item.name.toLowerCase().includes('cheese') || 
                                    item.name.toLowerCase().includes('yogurt') ||
                                    item.name.toLowerCase().includes('butter') ||
                                    item.name.toLowerCase().includes('eggs')) {
                                    itemCategory = 'dairy';
                                    itemIcon = 'fa-cheese';
                                } else if (item.name.toLowerCase().includes('bread') || 
                                          item.name.toLowerCase().includes('bun') || 
                                          item.name.toLowerCase().includes('bakery')) {
                                    itemCategory = 'bakery';
                                    itemIcon = 'fa-bread-slice';
                                } else if (item.name.toLowerCase().includes('apple') || 
                                          item.name.toLowerCase().includes('banana') || 
                                          item.name.toLowerCase().includes('fruit') ||
                                          item.name.toLowerCase().includes('vegetable') ||
                                          item.name.toLowerCase().includes('fresh') ||
                                          item.name.toLowerCase().includes('pepper') ||
                                          item.name.toLowerCase().includes('onion') ||
                                          item.name.toLowerCase().includes('cauliflower')) {
                                    itemCategory = 'fruits';
                                    itemIcon = 'fa-apple-alt';
                                } else if (item.name.toLowerCase().includes('milk') || 
                                          item.name.toLowerCase().includes('juice') || 
                                          item.name.toLowerCase().includes('water') || 
                                          item.name.toLowerCase().includes('coffee') ||
                                          item.name.toLowerCase().includes('drink') ||
                                          item.name.toLowerCase().includes('soda') ||
                                          item.name.toLowerCase().includes('bottle')) {
                                    itemCategory = 'drinks';
                                    itemIcon = 'fa-coffee';
                                }
                                
                                row.innerHTML = `
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="item-icon me-3 d-flex align-items-center justify-content-center" 
                                                 style="width: 40px; height: 40px; border-radius: 50%; background-color: rgba(79, 70, 229, 0.1);">
                                                <i class="fas ${itemIcon} text-${itemCategory === 'dairy' ? 'primary' : 
                                                               itemCategory === 'bakery' ? 'warning' : 
                                                               itemCategory === 'fruits' ? 'success' : 
                                                               itemCategory === 'drinks' ? 'info' : 'secondary'} fa-lg"></i>
                                            </div>
                                            <div>
                                                <div class="item-name fw-bold">${item.name}</div>
                                                <div class="badge bg-${itemCategory === 'dairy' ? 'primary' : 
                                                                 itemCategory === 'bakery' ? 'warning' : 
                                                                 itemCategory === 'fruits' ? 'success' : 
                                                                 itemCategory === 'drinks' ? 'info' : 'secondary'}">
                                                    ${itemCategory}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <div class="btn-group me-3">
                                                <button type="button" class="btn btn-sm btn-outline-primary roommate-btn" data-roommate="1">
                                                    <i class="fas fa-user"></i>1
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-success roommate-btn" data-roommate="2">
                                                    <i class="fas fa-user"></i>2
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-warning roommate-btn" data-roommate="3">
                                                    <i class="fas fa-user"></i>3
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-info roommate-btn" data-roommate="4">
                                                    <i class="fas fa-user"></i>4
                                                </button>
                                            </div>
                                            <div class="text-end">
                                                <div class="h5 mb-0 text-primary">$${price.toFixed(2)}</div>
                                                <small class="text-muted" id="item-${index}-sharing"></small>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                
                                itemsList.appendChild(row);
                            });

                            // Add event listeners for roommate assignment buttons
                            document.querySelectorAll('.roommate-btn').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const roommateNum = this.dataset.roommate;
                                    const roommateCheck = document.getElementById(`roommate${roommateNum}-check`);
                                    
                                    if (!roommateCheck.checked) {
                                        showToast(`Roommate ${roommateNum} is not active`, 'warning');
                                        return;
                                    }
                                    
                                    this.classList.toggle('active');
                                    if (this.classList.contains('active')) {
                                        this.classList.remove(`btn-outline-${this.classList.contains('btn-outline-primary') ? 'primary' : 
                                                              this.classList.contains('btn-outline-success') ? 'success' : 
                                                              this.classList.contains('btn-outline-warning') ? 'warning' : 'info'}`);
                                        this.classList.add(this.classList.contains('btn-outline-primary') ? 'btn-primary' : 
                                                         this.classList.contains('btn-outline-success') ? 'btn-success' : 
                                                         this.classList.contains('btn-outline-warning') ? 'btn-warning' : 'btn-info');
                                    } else {
                                        this.classList.remove(`btn-${this.classList.contains('btn-primary') ? 'primary' : 
                                                            this.classList.contains('btn-success') ? 'success' : 
                                                            this.classList.contains('btn-warning') ? 'warning' : 'info'}`);
                                        this.classList.add(this.classList.contains('btn-primary') ? 'btn-outline-primary' : 
                                                         this.classList.contains('btn-success') ? 'btn-outline-success' : 
                                                         this.classList.contains('btn-warning') ? 'btn-outline-warning' : 'btn-outline-info');
                                    }
                                    
                                    updateItemSharing(this.closest('.item-row'));
                                });
                            });
                        }
                        
                        // Update total amount
                        if (totalAmount) {
                            const total = data.items.reduce((sum, item) => sum + parseFloat(item.price), 0);
                            totalAmount.textContent = `$${total.toFixed(2)}`;
                        }
                        
                        // Show success message
                        // Add event listeners for roommate assignment buttons
                        document.querySelectorAll('.roommate-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const roommateNum = this.dataset.roommate;
                                const roommateCheck = document.getElementById(`roommate${roommateNum}-check`);
                                
                                if (!roommateCheck.checked) {
                                    showToast(`Roommate ${roommateNum} is not active`, 'warning');
                                    return;
                                }
                                
                                this.classList.toggle('active');
                                if (this.classList.contains('active')) {
                                    this.classList.remove(`btn-outline-${this.classList.contains('btn-outline-primary') ? 'primary' : 
                                                          this.classList.contains('btn-outline-success') ? 'success' : 
                                                          this.classList.contains('btn-outline-warning') ? 'warning' : 'info'}`);
                                    this.classList.add(this.classList.contains('btn-outline-primary') ? 'btn-primary' : 
                                                     this.classList.contains('btn-outline-success') ? 'btn-success' : 
                                                     this.classList.contains('btn-outline-warning') ? 'btn-warning' : 'btn-info');
                                } else {
                                    this.classList.remove(`btn-${this.classList.contains('btn-primary') ? 'primary' : 
                                                        this.classList.contains('btn-success') ? 'success' : 
                                                        this.classList.contains('btn-warning') ? 'warning' : 'info'}`);
                                    this.classList.add(this.classList.contains('btn-primary') ? 'btn-outline-primary' : 
                                                     this.classList.contains('btn-success') ? 'btn-outline-success' : 
                                                     this.classList.contains('btn-warning') ? 'btn-outline-warning' : 'btn-outline-info');
                                }
                                
                                updateItemSharing(this.closest('.item-row'));
                            });
                        });
                    }
                    
                    // Update total amount
                    if (totalAmount) {
                        const total = data.items.reduce((sum, item) => sum + parseFloat(item.price), 0);
                        totalAmount.textContent = `$${total.toFixed(2)}`;
                    }
                    
                    // Show success message
                    showToast('Receipt parsed successfully!', 'success');
                } catch (error) {
                    console.error('Error parsing receipt:', error);
                    showError(error.message || 'An error occurred while parsing the receipt');
                }
            }
            
            // Get item view elements
            const jsonView = document.getElementById('json-view');
            const itemView = document.getElementById('item-view');
            const costSummary = document.getElementById('cost-summary');
            const costSummaryList = document.getElementById('cost-summary-list');
            
            // Calculate shares
            if (calculateBtn) {
                calculateBtn.addEventListener('click', function() {
                    console.log('Calculate shares button clicked');
                    calculateCostShares();
                });
            }
            
            // Item selection and sharing buttons
            const selectAllBtn = document.getElementById('select-all-btn');
            const clearSelectionsBtn = document.getElementById('clear-selections-btn');
            const splitEvenlyBtn = document.getElementById('split-evenly-btn');
            const saveDistributionBtn = document.getElementById('save-distribution-btn');
            const shareDistributionBtn = document.getElementById('share-distribution-btn');
            const generateReceiptBtn = document.getElementById('generate-receipt-btn');
            const saveSuccessAlert = document.getElementById('save-success-alert');
            
            // Floating Action Button (FAB) menu items
            const fabSplitBtn = document.getElementById('fab-split-btn');
            const fabSelectAllBtn = document.getElementById('fab-select-all-btn');
            const fabClearBtn = document.getElementById('fab-clear-btn');
            const fabCalculateBtn = document.getElementById('fab-calculate-btn');
            
            // Share modal elements
            const shareModal = document.getElementById('shareModal');
            const bsShareModal = shareModal ? new bootstrap.Modal(shareModal) : null;
            const copyLinkBtn = document.getElementById('copy-link-btn');
            const shareBtns = document.querySelectorAll('.share-btn');
            
            // Quick assignment buttons
            const assignDrinksBtn = document.getElementById('assign-drinks-btn');
            const assignFruitsBtn = document.getElementById('assign-fruits-btn');
            const assignDairyBtn = document.getElementById('assign-dairy-btn');
            const assignBakeryBtn = document.getElementById('assign-bakery-btn');
            
            // Event listeners for the selection buttons
            selectAllBtn?.addEventListener('click', function() {
                selectAllItems();
            });
            
            clearSelectionsBtn?.addEventListener('click', function() {
                clearAllSelections();
            });
            
            splitEvenlyBtn?.addEventListener('click', function() {
                splitItemsEvenly();
                // Show a toast notification
                showToast('All items have been split evenly among active users', 'success');
            });
            
            saveDistributionBtn?.addEventListener('click', function() {
                saveDistribution();
            });
            
            shareDistributionBtn?.addEventListener('click', function() {
                showShareDialog();
            });
            
            generateReceiptBtn?.addEventListener('click', function() {
                generateReceiptsForUsers();
            });
            
            // Copy link functionality
            copyLinkBtn?.addEventListener('click', function() {
                const shareLink = document.getElementById('share-link');
                if (shareLink) {
                    shareLink.select();
                    document.execCommand('copy');
                    this.innerHTML = '<i class="fas fa-check"></i>';
                    setTimeout(() => {
                        this.innerHTML = '<i class="fas fa-copy"></i>';
                    }, 2000);
                }
            });
            
            // Share buttons functionality
            shareBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const platform = this.dataset.platform;
                    const shareLink = document.getElementById('share-link');
                    if (!shareLink) return;
                    
                    const url = shareLink.value;
                    let shareUrl;
                    switch(platform) {
                        case 'email':
                            shareUrl = `mailto:?subject=Cost%20sharing%20for%20Walmart%20Receipt&body=Check%20out%20our%20cost%20sharing:%20${encodeURIComponent(url)}`;
                            break;
                        case 'whatsapp':
                            shareUrl = `https://wa.me/?text=${encodeURIComponent('Check out our cost sharing: ' + url)}`;
                            break;
                        case 'telegram':
                            shareUrl = `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent('Check out our cost sharing')}`;
                            break;
                    }
                    
                    if (shareUrl) {
                        window.open(shareUrl, '_blank');
                    }
                });
            });
            
            // Quick assignment buttons
            assignDrinksBtn?.addEventListener('click', function() {
                assignCategoryToUser('drinks');
            });
            
            assignFruitsBtn?.addEventListener('click', function() {
                assignCategoryToUser('fruits');
            });
            
            assignDairyBtn?.addEventListener('click', function() {
                assignCategoryToUser('dairy');
            });
            
            assignBakeryBtn?.addEventListener('click', function() {
                assignCategoryToUser('bakery');
            });
            
            // Floating Action Button (FAB) menu items event listeners
            fabSplitBtn?.addEventListener('click', function() {
                splitItemsEvenly();
                showToast('Split all items evenly among active users', 'success');
            });
            
            fabSelectAllBtn?.addEventListener('click', function() {
                selectAllItems();
                
                // Toast is added inside selectAllItems function
            });
            
            fabClearBtn?.addEventListener('click', function() {
                clearAllSelections();
                
                // Toast is added inside clearAllSelections function
            });
            
            fabCalculateBtn?.addEventListener('click', function() {
                calculateCostShares();
                
                // Toast is added inside calculateCostShares function
            });
            
            // Parse and display JSON data
            function displayJson(data) {
                // Store JSON data in hidden view
                const formattedJson = JSON.stringify(data, null, 2);
                resultContainer.textContent = formattedJson;
                
                // Show result container
                resultContainerWrapper.classList.remove('hidden');
                emptyState.classList.add('hidden');
                
                // Hide cost summary on new upload
                costSummary.classList.add('d-none');
                
                // Set total amount
                let total = 0;
                
                // Display items in the item view
                itemsList.innerHTML = '';
                if (data.items && Array.isArray(data.items)) {
                    data.items.forEach((item, index) => {
                        const price = parseFloat(item.price);
                        total += price;
                        
                        const row = document.createElement('tr');
                        row.className = 'item-row';
                        row.dataset.index = index;
                        row.dataset.price = price;
                        row.dataset.name = item.name;
                        
                        // Determine item category for icon
                        let itemCategory = 'other';
                        let itemIcon = 'fa-shopping-basket';
                        
                        // Simple category detection based on item name
                        if (item.name.toLowerCase().includes('milk') || 
                            item.name.toLowerCase().includes('cheese') || 
                            item.name.toLowerCase().includes('yogurt') ||
                            item.name.toLowerCase().includes('butter')) {
                            itemCategory = 'dairy';
                            itemIcon = 'fa-cheese';
                        } else if (item.name.toLowerCase().includes('bread') || 
                                  item.name.toLowerCase().includes('bun') || 
                                  item.name.toLowerCase().includes('bakery')) {
                            itemCategory = 'bakery';
                            itemIcon = 'fa-bread-slice';
                        } else if (item.name.toLowerCase().includes('apple') || 
                                  item.name.toLowerCase().includes('banana') || 
                                  item.name.toLowerCase().includes('fruit') ||
                                  item.name.toLowerCase().includes('vegetable') ||
                                  item.name.toLowerCase().includes('fresh') ||
                                  item.name.toLowerCase().includes('pepper') ||
                                  item.name.toLowerCase().includes('onion') ||
                                  item.name.toLowerCase().includes('cauliflower')) {
                            itemCategory = 'fruits';
                            itemIcon = 'fa-apple-alt';
                        } else if (item.name.toLowerCase().includes('milk') || 
                                  item.name.toLowerCase().includes('juice') || 
                                  item.name.toLowerCase().includes('water') || 
                                  item.name.toLowerCase().includes('coffee') ||
                                  item.name.toLowerCase().includes('drink') ||
                                  item.name.toLowerCase().includes('soda') ||
                                  item.name.toLowerCase().includes('bottle')) {
                            itemCategory = 'drinks';
                            itemIcon = 'fa-coffee';
                        }
                        
                        // Store category in dataset
                        row.dataset.category = itemCategory;
                        
                        // Create color-coded buttons for each user
                        const buttonColors = [
                            { borderClass: 'btn-outline-primary', activeClass: 'btn-primary', color: 'primary' },
                            { borderClass: 'btn-outline-success', activeClass: 'btn-success', color: 'success' },
                            { borderClass: 'btn-outline-warning', activeClass: 'btn-warning', color: 'warning' },
                            { borderClass: 'btn-outline-info', activeClass: 'btn-info', color: 'info' }
                        ];
                        
                        let buttonGroup = '';
                        for (let i = 1; i <= 4; i++) {
                            buttonGroup += `
                                <input type="checkbox" class="btn-check" name="item-${index}-user${i}" id="item-${index}-user${i}" autocomplete="off">
                                <label class="btn ${buttonColors[i-1].borderClass} rounded-pill me-1" for="item-${index}-user${i}" data-user="${i}" data-color="${buttonColors[i-1].activeClass}" data-user-color="${buttonColors[i-1].color}">
                                    <i class="fas fa-user me-1"></i>${i}
                                </label>
                            `;
                        }
                        
                        // Add the "All Users" button
                        buttonGroup += `
                            <button class="btn btn-outline-danger rounded-pill ms-1 assign-all-btn" data-index="${index}" title="Assign to all active users">
                                <i class="fas fa-users me-1"></i>All
                            </button>
                        `;
                        
                        row.innerHTML = `
                            <td class="text-light">
                                <div class="d-flex">
                                    <div class="item-icon me-3 d-flex align-items-center justify-content-center" 
                                         style="width: 40px; height: 40px; border-radius: 50%; background-color: rgba(255,255,255,0.1);">
                                        <i class="fas ${itemIcon} text-${itemCategory === 'dairy' ? 'light' : 
                                                       itemCategory === 'bakery' ? 'warning' : 
                                                       itemCategory === 'fruits' ? 'success' : 
                                                       itemCategory === 'drinks' ? 'info' : 'light'} fa-lg"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between">
                                            <span class="item-name fw-bold">${item.name}</span>
                                            <span class="text-warning ms-2 fw-bold">$${price.toFixed(2)}</span>
                                        </div>
                                        <div class="item-actions mt-2 d-flex align-items-center">
                                            <span class="badge bg-dark text-${itemCategory === 'dairy' ? 'light' : 
                                                                        itemCategory === 'bakery' ? 'warning' : 
                                                                        itemCategory === 'fruits' ? 'success' : 
                                                                        itemCategory === 'drinks' ? 'info' : 'light'} item-category">
                                                ${itemCategory}
                                            </span>
                                            <span class="ms-auto assignment-count text-muted small">Not assigned</span>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="text-center align-middle" style="width: 40%;">
                                <div class="user-assignment-section">
                                    <div class="assignment-buttons d-flex flex-wrap justify-content-end align-items-center gap-2" role="group">
                                        ${buttonGroup}
                                    </div>
                                </div>
                            </td>
                        `;
                        itemsList.appendChild(row);
                    });
                    
                    // Add event listeners for the assignment buttons
                    setupAssignmentButtons();
                }
                
                totalAmount.textContent = `$${total.toFixed(2)}`;
                
                // Hide the success alert
                saveSuccessAlert.classList.add('d-none');
            }
            
            // Setup event listeners for assignment buttons
            function setupAssignmentButtons() {
                // Setup user assignment buttons
                const assignmentButtons = document.querySelectorAll('.assignment-buttons label');
                assignmentButtons.forEach(button => {
                    button.addEventListener('click', function(e) {
                        const checkbox = document.getElementById(this.getAttribute('for'));
                        if (checkbox) {
                            // Toggle the checkbox
                            checkbox.checked = !checkbox.checked;
                            
                            // Toggle the active state visually
                            if (checkbox.checked) {
                                this.classList.add(this.dataset.color);
                                this.classList.add('active');
                            } else {
                                this.classList.remove(this.dataset.color);
                                this.classList.remove('active');
                            }
                            
                            // Update assignment count for this item
                            updateAssignmentCount(this.closest('tr'));
                            
                            // Calculate costs live without needing to press a button
                            calculateCostShares();
                        }
                    });
                });
                
                // Setup "Assign All" buttons
                const assignAllBtns = document.querySelectorAll('.assign-all-btn');
                assignAllBtns.forEach(button => {
                    button.addEventListener('click', function() {
                        const index = this.dataset.index;
                        const row = this.closest('tr');
                        
                        // Toggle button state
                        if (this.classList.contains('btn-danger')) {
                            // If active, deselect all
                            this.classList.remove('btn-danger');
                            this.classList.add('btn-outline-danger');
                            
                            // Clear all selections for this item
                            const activeUsers = getActiveUsers();
                            activeUsers.forEach(user => {
                                const checkbox = document.getElementById(`item-${index}-${user.id}`);
                                const label = document.querySelector(`label[for="item-${index}-${user.id}"]`);
                                
                                if (checkbox) {
                                    checkbox.checked = false;
                                    if (label) {
                                        label.classList.remove(label.dataset.color, 'active');
                                    }
                                }
                            });
                        } else {
                            // If not active, select all
                            this.classList.remove('btn-outline-danger');
                            this.classList.add('btn-danger');
                            
                            // Assign to all active users
                            const activeUsers = getActiveUsers();
                            if (activeUsers.length === 0) {
                                showError('Please activate at least one user first');
                                return;
                            }
                            
                            activeUsers.forEach(user => {
                                const checkbox = document.getElementById(`item-${index}-${user.id}`);
                                const label = document.querySelector(`label[for="item-${index}-${user.id}"]`);
                                
                                if (checkbox && label) {
                                    checkbox.checked = true;
                                    label.classList.add(label.dataset.color, 'active');
                                }
                            });
                        }
                        
                        // Update assignment count
                        updateAssignmentCount(row);
                        
                        // Calculate costs live without needing to press a button
                        calculateCostShares();
                        
                        // Show a toast notification
                        if (this.classList.contains('btn-danger')) {
                            const itemName = row.dataset.name;
                            const shortName = itemName.length > 20 ? itemName.substring(0, 20) + '...' : itemName;
                            const activeUsers = getActiveUsers();
                            const toast = showToast(`"${shortName}" assigned to all ${activeUsers.length} user${activeUsers.length > 1 ? 's' : ''}`, 'success');
                        }
                    });
                });
                
                // Split item buttons have been removed
            }
            
            // Update the assignment count for an item
            function updateAssignmentCount(row) {
                if (!row) return;
                
                const index = row.dataset.index;
                const activeUsers = getActiveUsers();
                let count = 0;
                
                activeUsers.forEach(user => {
                    const checkbox = document.getElementById(`item-${index}-${user.id}`);
                    if (checkbox && checkbox.checked) {
                        count++;
                    }
                });
                
                const countDisplay = row.querySelector('.assignment-count');
                if (countDisplay) {
                    if (count === 0) {
                        countDisplay.textContent = 'Not assigned';
                        countDisplay.className = 'assignment-count text-muted';
                    } else {
                        countDisplay.textContent = `${count} user${count > 1 ? 's' : ''}`;
                        countDisplay.className = 'assignment-count text-success';
                    }
                }
            }
            
            // Split a single item evenly among active users
            function splitSingleItem(row) {
                const activeUsers = getActiveUsers();
                if (activeUsers.length === 0) {
                    showError('Please activate at least one user first');
                    return;
                }
                
                const index = row.dataset.index;
                
                // Clear existing assignments for this item
                activeUsers.forEach(user => {
                    const checkbox = document.getElementById(`item-${index}-${user.id}`);
                    const label = document.querySelector(`label[for="item-${index}-${user.id}"]`);
                    
                    if (checkbox) {
                        checkbox.checked = false;
                        if (label) {
                            label.classList.remove(label.dataset.color, 'active');
                        }
                    }
                });
                
                // Assign to all active users
                activeUsers.forEach(user => {
                    const checkbox = document.getElementById(`item-${index}-${user.id}`);
                    const label = document.querySelector(`label[for="item-${index}-${user.id}"]`);
                    
                    if (checkbox && label) {
                        checkbox.checked = true;
                        label.classList.add(label.dataset.color, 'active');
                    }
                });
                
                // Update assignment count
                updateAssignmentCount(row);
            }
            
            // Split all items evenly among active users
            function splitItemsEvenly() {
                const activeUsers = getActiveUsers();
                if (activeUsers.length === 0) {
                    showError('Please activate at least one user first');
                    return;
                }
                
                // Clear all selections first
                clearAllSelections();
                
                // Get all item rows
                const itemRows = document.querySelectorAll('.item-row');
                
                // Distribute items evenly
                itemRows.forEach(row => {
                    splitSingleItem(row);
                    
                    // Also update the "All" button for each item
                    const assignAllBtn = row.querySelector('.assign-all-btn');
                    if (assignAllBtn) {
                        assignAllBtn.classList.remove('btn-outline-danger');
                        assignAllBtn.classList.add('btn-danger');
                    }
                });
                
                // Calculate costs live without needing to press a button
                calculateCostShares();
                
                // Show success message
                showSuccess('All items have been split evenly among all active users');
            }
            
            // Event listeners for user checkboxes
            document.querySelectorAll('.user-check').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const userId = this.value;
                    const userCard = this.closest('.card');
                    const statusBadge = userCard.querySelector('.badge');
                    
                    if (this.checked) {
                        // Update status badge when active
                        const userColor = userId === 'user1' ? 'primary' : 
                                        userId === 'user2' ? 'success' : 
                                        userId === 'user3' ? 'warning' : 'info';
                        
                        if (statusBadge) {
                            statusBadge.className = `badge rounded-pill bg-${userColor}`;
                            statusBadge.innerHTML = '<i class="fas fa-circle me-1"></i>Active';
                            
                            // Add text-dark class for warning color
                            if (userId === 'user3') {
                                statusBadge.classList.add('text-dark');
                            }
                        }
                        
                        // Recalculate costs when user status changes
                        calculateCostShares();
                    } else {
                        // Update status badge when inactive
                        if (statusBadge) {
                            statusBadge.className = 'badge rounded-pill bg-secondary';
                            statusBadge.innerHTML = '<i class="fas fa-circle me-1"></i>Inactive';
                        }
                        
                        // Recalculate costs when user status changes
                        calculateCostShares();
                    }
                });
            });
            
            // Assign items of a specific category to an active user
            function assignCategoryToUser(category) {
                const activeUsers = getActiveUsers();
                if (activeUsers.length === 0) {
                    showError('Please activate at least one user first');
                    return;
                }
                
                // Show a dialog to select which user to assign to
                const userSelection = prompt(`Assign all ${category} items to which user? Enter user number (1-4):`);
                if (!userSelection) return;
                
                const userNumber = parseInt(userSelection);
                if (isNaN(userNumber) || userNumber < 1 || userNumber > 4) {
                    showError('Please enter a valid user number between 1 and 4');
                    return;
                }
                
                const userId = `user${userNumber}`;
                
                // Check if this user is active
                const userIsActive = activeUsers.some(user => user.id === userId);
                if (!userIsActive) {
                    showError(`User ${userNumber} is not active. Please activate this user first.`);
                    return;
                }
                
                // Get all items of this category
                const itemRows = document.querySelectorAll(`.item-row[data-category="${category}"]`);
                
                if (itemRows.length === 0) {
                    showError(`No items found in the '${category}' category`);
                    return;
                }
                
                // Assign items to the selected user
                itemRows.forEach(row => {
                    const index = row.dataset.index;
                    
                    // Clear existing assignments for this item (optional)
                    activeUsers.forEach(user => {
                        const checkbox = document.getElementById(`item-${index}-${user.id}`);
                        const label = document.querySelector(`label[for="item-${index}-${user.id}"]`);
                        
                        if (checkbox) {
                            checkbox.checked = false;
                            if (label) {
                                label.classList.remove(label.dataset.color, 'active');
                            }
                        }
                    });
                    
                    // Assign to selected user
                    const checkbox = document.getElementById(`item-${index}-${userId}`);
                    const label = document.querySelector(`label[for="item-${index}-${userId}"]`);
                    
                    if (checkbox && label) {
                        checkbox.checked = true;
                        label.classList.add(label.dataset.color, 'active');
                    }
                    
                    // Update assignment count
                    updateAssignmentCount(row);
                });
                
                // Calculate costs live without needing to press a button
                calculateCostShares();
                
                // Show success message
                const userName = document.getElementById(`${userId}-name`).value;
                showSuccess(`Assigned all ${category} items to ${userName}`);
            }
            
            // Show share dialog
            function showShareDialog() {
                // First, make sure we have a distribution to share
                const costData = collectCostSummary();
                if (!costData || costData.users.length === 0) {
                    showError('Please calculate shares first');
                    return;
                }
                
                // Generate a share link (this would normally include an ID or token)
                const host = window.location.origin;
                const distributionId = costData.distribution_id || Date.now();  // Use saved ID or timestamp
                const shareLink = `${host}/distribution/${distributionId}`;
                
                // Set the share link in the dialog
                const shareLinkInput = document.getElementById('share-link');
                if (shareLinkInput) {
                    shareLinkInput.value = shareLink;
                }
                
                // Show the modal
                bsShareModal?.show();
            }
            
            // Generate receipts for each user
            function generateReceiptsForUsers() {
                // First, make sure we have a distribution to share
                const costData = collectCostSummary();
                if (!costData || costData.users.length === 0) {
                    showError('Please calculate shares first');
                    return;
                }
                
                // In a real app, this would generate PDFs or display printable receipts
                // For now, we'll just show a message
                showSuccess('Receipts have been generated and are ready to view!');
                
                // Normally, this would open a new page or download the receipts
                alert("This feature would generate individual receipts for each user showing their items and costs.");
            }
            
            // Show success message
            function showSuccess(message) {
                // Use toast for less intrusive notifications
                showToast(message, 'success');
                
                // Also create a dismissible alert for more important messages
                const successAlert = document.createElement('div');
                successAlert.className = 'alert alert-success alert-dismissible fade show mt-3';
                successAlert.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                // Add to the page
                const container = document.querySelector('.card-body');
                container.appendChild(successAlert);
                
                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    successAlert.classList.remove('show');
                    setTimeout(() => successAlert.remove(), 500);
                }, 5000);
            }
            
            // Show a toast notification
            function showToast(message, type = 'info') {
                // Create toast container if it doesn't exist
                let toastContainer = document.querySelector('.toast-container');
                if (!toastContainer) {
                    toastContainer = document.createElement('div');
                    toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                    toastContainer.style.zIndex = '1100';
                    document.body.appendChild(toastContainer);
                }
                
                // Create the toast element
                const toastId = 'toast-' + Date.now();
                const toast = document.createElement('div');
                toast.className = `toast align-items-center border-0 bg-${type}`;
                toast.id = toastId;
                toast.setAttribute('role', 'alert');
                toast.setAttribute('aria-live', 'assertive');
                toast.setAttribute('aria-atomic', 'true');
                
                // Add darker text for warning and info toasts
                const textClass = type === 'warning' || type === 'info' ? 'text-dark' : 'text-white';
                
                toast.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body ${textClass}">
                            <i class="fas fa-${type === 'success' ? 'check-circle' : 
                                             type === 'warning' ? 'exclamation-triangle' : 
                                             type === 'danger' ? 'times-circle' : 'info-circle'} me-2"></i>
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-${type === 'warning' || type === 'info' ? 'dark' : 'white'} me-2 m-auto" 
                                data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                `;
                
                // Add to container
                toastContainer.appendChild(toast);
                
                // Initialize and show toast
                const bsToast = new bootstrap.Toast(toast, {
                    delay: 3000,
                    autohide: true
                });
                
                bsToast.show();
                
                // Remove toast after it's hidden
                toast.addEventListener('hidden.bs.toast', function() {
                    toast.remove();
                    // Remove container if empty
                    if (toastContainer.children.length === 0) {
                        toastContainer.remove();
                    }
                });
                
                return bsToast;
            }
            
            // Select all items for active users
            function selectAllItems() {
                const activeUsers = getActiveUsers();
                if (activeUsers.length === 0) {
                    showError('Please activate at least one user first');
                    return;
                }
                
                const itemRows = document.querySelectorAll('.item-row');
                itemRows.forEach(row => {
                    const index = row.dataset.index;
                    
                    activeUsers.forEach(user => {
                        const checkbox = document.getElementById(`item-${index}-${user.id}`);
                        const label = document.querySelector(`label[for="item-${index}-${user.id}"]`);
                        
                        if (checkbox && label) {
                            checkbox.checked = true;
                            label.classList.add(label.dataset.color, 'active');
                        }
                    });
                    
                    // Also update the "All" button for each item
                    const assignAllBtn = row.querySelector('.assign-all-btn');
                    if (assignAllBtn) {
                        assignAllBtn.classList.remove('btn-outline-danger');
                        assignAllBtn.classList.add('btn-danger');
                    }
                    
                    // Update assignment count
                    updateAssignmentCount(row);
                });
                
                // Calculate costs live without needing to press a button
                calculateCostShares();
                
                // Show a success message
                showToast(`Selected all items for ${activeUsers.length} active user${activeUsers.length > 1 ? 's' : ''}`, 'success');
            }
            
            // Clear all selections
            function clearAllSelections() {
                const checkboxes = document.querySelectorAll('.btn-check');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                    const label = document.querySelector(`label[for="${checkbox.id}"]`);
                    if (label) {
                        label.classList.remove(label.dataset.color, 'active');
                    }
                });
                
                // Clear all "All" buttons
                const allButtons = document.querySelectorAll('.assign-all-btn');
                allButtons.forEach(btn => {
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-outline-danger');
                });
                
                // Update assignment counts
                document.querySelectorAll('.item-row').forEach(row => {
                    updateAssignmentCount(row);
                });
                
                // Calculate costs live without needing to press a button
                calculateCostShares();
                
                // Show toast notification
                showToast('All selections cleared', 'info');
            }
            
            // Save the distribution to the database
            async function saveDistribution() {
                const costData = collectCostSummary();
                if (!costData || costData.users.length === 0) {
                    showError('Please calculate shares first');
                    return;
                }
                
                try {
                    const response = await fetch('/api/save_distribution', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(costData)
                    });
                    
                    if (response.ok) {
                        // Show success message with both alert and toast
                        saveSuccessAlert.classList.remove('d-none');
                        
                        // Show toast notification
                        showToast('Distribution saved successfully!', 'success');
                        
                        // Scroll to see the alert
                        saveSuccessAlert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    } else {
                        const data = await response.json();
                        throw new Error(data.error || 'Failed to save distribution');
                    }
                } catch (error) {
                    console.error('Error saving distribution:', error);
                    showError(error.message || 'Failed to save distribution');
                }
            }
            
            // Collect the cost summary data for saving
            function collectCostSummary() {
                const activeUsers = getActiveUsers();
                if (activeUsers.length === 0) return null;
                
                const items = [];
                const itemRows = document.querySelectorAll('.item-row');
                itemRows.forEach(row => {
                    const itemData = {
                        name: row.dataset.name,
                        price: parseFloat(row.dataset.price),
                        users: []
                    };
                    
                    const index = row.dataset.index;
                    activeUsers.forEach(user => {
                        const checkbox = document.getElementById(`item-${index}-${user.id}`);
                        if (checkbox && checkbox.checked) {
                            itemData.users.push(user.id);
                        }
                    });
                    
                    items.push(itemData);
                });
                
                return {
                    items: items,
                    users: activeUsers.map(user => ({
                        id: user.id,
                        name: user.name
                    })),
                    total: parseFloat(totalAmount.textContent.replace('$', ''))
                };
            }
            
            // Get active users function for reuse
            function getActiveUsers() {
                const activeUsers = [];
                for (let i = 1; i <= 4; i++) {
                    const userCheck = document.getElementById(`user${i}-check`);
                    if (userCheck && userCheck.checked) {
                        const userName = document.getElementById(`user${i}-name`).value;
                        activeUsers.push({
                            id: `user${i}`,
                            name: userName,
                            total: 0,
                            items: []
                        });
                    }
                }
                return activeUsers;
            }
            
            // Calculate cost shares based on item assignments
            function calculateCostShares() {
                // Get active users
                const activeUsers = getActiveUsers();
                if (activeUsers.length === 0) {
                    showError('Please activate at least one user');
                    return;
                }
                
                // Reset any previous calculations
                activeUsers.forEach(user => {
                    user.total = 0;
                    user.items = [];
                });
                
                // Go through each item and calculate shares
                const itemRows = document.querySelectorAll('.item-row');
                itemRows.forEach(row => {
                    const itemName = row.dataset.name;
                    const itemPrice = parseFloat(row.dataset.price);
                    const index = row.dataset.index;
                    
                    // Count how many users are assigned to this item
                    const assignedUsers = [];
                    for (const user of activeUsers) {
                        const checkbox = document.getElementById(`item-${index}-${user.id}`);
                        if (checkbox && checkbox.checked) {
                            assignedUsers.push(user);
                        }
                    }
                    
                    // Calculate share per assigned user
                    const usersCount = assignedUsers.length;
                    if (usersCount > 0) {
                        const pricePerUser = itemPrice / usersCount;
                        
                        // Add to each user's total
                        for (const user of assignedUsers) {
                            const userIndex = activeUsers.findIndex(u => u.id === user.id);
                            if (userIndex !== -1) {
                                activeUsers[userIndex].total += pricePerUser;
                                activeUsers[userIndex].items.push({
                                    name: itemName,
                                    price: itemPrice,
                                    share: pricePerUser,
                                    shared_with: usersCount > 1 ? usersCount - 1 : 0
                                });
                            }
                        }
                    }
                });
                
                // Display cost summary
                costSummaryList.innerHTML = '';
                for (const user of activeUsers) {
                    const row = document.createElement('tr');
                    
                    // Use color coding matching the user's color
                    let userColor = '';
                    let textColor = '';
                    switch(user.id) {
                        case 'user1': userColor = 'primary'; textColor = 'text-primary'; break;
                        case 'user2': userColor = 'success'; textColor = 'text-success'; break;
                        case 'user3': userColor = 'warning'; textColor = 'text-warning'; break;
                        case 'user4': userColor = 'info'; textColor = 'text-info'; break;
                    }
                    
                    // Create item list for this user with better formatting
                    const itemsList = user.items.map(item => {
                        // Show sharing info if shared with others
                        const sharingBadge = item.shared_with > 0 
                            ? `<span class="badge bg-secondary ms-1" title="Shared with ${item.shared_with} other user(s)">
                                <i class="fas fa-share-alt me-1"></i>${item.shared_with + 1}
                               </span>` 
                            : '';
                            
                        return `<div class="mb-1 d-flex justify-content-between align-items-center">
                            <div>
                                <span class="item-name small text-truncate" style="max-width: 180px;" title="${item.name}">
                                    ${item.name}
                                </span>
                                ${sharingBadge}
                            </div>
                            <div>
                                <span class="ms-2 badge bg-${userColor}">$${item.share.toFixed(2)}</span>
                                ${item.shared_with > 0 
                                   ? `<span class="ms-1 badge bg-dark text-${userColor}">
                                      <small>${((item.share / item.price) * 100).toFixed(0)}%</small>
                                      </span>`
                                   : ''}
                            </div>
                        </div>`;
                    }).join('');
                    
                    row.innerHTML = `
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-${userColor} me-2"><i class="fas fa-user"></i></span>
                                <span class="fw-bold text-dark">${user.name}</span>
                            </div>
                        </td>
                        <td class="${textColor} fw-bold">$${user.total.toFixed(2)}</td>
                        <td>
                            <div class="user-items-list">
                                ${user.items.length > 0 ? itemsList : '<em class="text-muted">No items</em>'}
                            </div>
                        </td>
                    `;
                    
                    costSummaryList.appendChild(row);
                }
                
                // Show cost summary
                costSummary.classList.remove('d-none');
                
                // Scroll to the cost summary
                costSummary.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // Show a toast notification with summary info
                const totalAmount = activeUsers.reduce((sum, user) => sum + user.total, 0).toFixed(2);
                showToast(`Calculated shares: $${totalAmount} total for ${activeUsers.length} user${activeUsers.length > 1 ? 's' : ''}`, 'success');
            }
            
            function clearAll() {
                console.log('Clearing all');
                fileInput.value = '';
                fileInfo.classList.add('hidden');
                uploadPrompt.classList.remove('hidden');
                resultContainer.textContent = '';
                resultContainerWrapper.classList.add('hidden');
                emptyState.classList.remove('hidden');
                hideError();
                
                // Reset items list and cost summary
                itemsList.innerHTML = '';
                costSummaryList.innerHTML = '';
                costSummary.classList.add('d-none');
                totalAmount.textContent = '$0.00';
            }
            
            async function copyJsonToClipboard() {
                if (!resultContainer.textContent) return;
                
                try {
                    await navigator.clipboard.writeText(resultContainer.textContent);
                    const originalText = copyButton.innerHTML;
                    copyButton.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
                    
                    setTimeout(() => {
                        copyButton.innerHTML = originalText;
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                }
            }
            
            function showError(message) {
                console.log('Showing error:', message);
                if (errorAlert) {
                    errorAlert.textContent = message;
                    errorAlert.classList.remove('hidden');
                    
                    // Auto-dismiss after 5 seconds
                    setTimeout(() => {
                        hideError();
                    }, 5000);
                }
            }
            
            function hideError() {
                console.log('Hiding error');
                if (errorAlert) {
                    errorAlert.classList.add('hidden');
                }
            }

            // Update the updateItemSharing function to also update roommate totals
            function updateItemSharing(itemRow) {
                const index = itemRow.dataset.index;
                const price = parseFloat(itemRow.dataset.price);
                const sharingElement = document.getElementById(`item-${index}-sharing`);
                
                const assignedRoommates = itemRow.querySelectorAll('.roommate-btn.active');
                const count = assignedRoommates.length;
                
                if (count === 0) {
                    sharingElement.textContent = 'Not assigned';
                    sharingElement.className = 'text-muted';
                } else {
                    const sharePerPerson = price / count;
                    sharingElement.textContent = `$${sharePerPerson.toFixed(2)} each (${count} sharing)`;
                    sharingElement.className = 'text-success';
                }
                
                // Update roommate totals
                updateRoommateTotals();
            }

            // Add new function to update roommate totals
            function updateRoommateTotals() {
                const roommateTotals = {
                    1: { total: 0, items: [], color: 'primary' },
                    2: { total: 0, items: [], color: 'success' },
                    3: { total: 0, items: [], color: 'warning' },
                    4: { total: 0, items: [], color: 'info' }
                };
                
                document.querySelectorAll('.item-row').forEach(row => {
                    const price = parseFloat(row.dataset.price);
                    const name = row.dataset.name;
                    const assignedRoommates = row.querySelectorAll('.roommate-btn.active');
                    
                    if (assignedRoommates.length > 0) {
                        const sharePerPerson = price / assignedRoommates.length;
                        assignedRoommates.forEach(btn => {
                            const roommateNum = btn.dataset.roommate;
                            roommateTotals[roommateNum].total += sharePerPerson;
                            roommateTotals[roommateNum].items.push({
                                name: name,
                                price: sharePerPerson,
                                shared: assignedRoommates.length > 1
                            });
                        });
                    }
                });
                
                // Update each roommate's card
                Object.entries(roommateTotals).forEach(([num, data]) => {
                    const totalElement = document.getElementById(`roommate${num}-total`);
                    const itemsElement = document.getElementById(`roommate${num}-items`);
                    const roommateCheck = document.getElementById(`roommate${num}-check`);
                    
                    if (totalElement && itemsElement && roommateCheck) {
                        if (roommateCheck.checked) {
                            totalElement.textContent = `$${data.total.toFixed(2)}`;
                            totalElement.className = `h5 mb-0 text-${data.color}`;
                            
                            if (data.items.length === 0) {
                                itemsElement.textContent = 'No items assigned';
                                itemsElement.className = 'text-muted';
                            } else {
                                const itemCount = data.items.length;
                                const sharedCount = data.items.filter(item => item.shared).length;
                                itemsElement.textContent = `${itemCount} item${itemCount !== 1 ? 's' : ''}${sharedCount > 0 ? ` (${sharedCount} shared)` : ''}`;
                                itemsElement.className = 'text-success';
                            }
                        } else {
                            totalElement.textContent = '$0.00';
                            totalElement.className = 'h5 mb-0 text-muted';
                            itemsElement.textContent = 'Inactive';
                            itemsElement.className = 'text-muted';
                        }
                    }
                });
            }

            // Update roommate check event listeners to update totals
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`roommate${i}-check`).addEventListener('change', function() {
                    updateRoommateTotals();
                });
            }

            // Update roommate name event listeners to update totals
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`roommate${i}-name`).addEventListener('change', function() {
                    updateRoommateTotals();
                });
            }

            // Update assign all button to update totals
            document.getElementById('assign-all-btn').addEventListener('click', function() {
                document.querySelectorAll('.item-row').forEach(row => {
                    row.querySelectorAll('.roommate-btn').forEach(btn => {
                        const roommateNum = btn.dataset.roommate;
                        const roommateCheck = document.getElementById(`roommate${roommateNum}-check`);
                        if (roommateCheck && roommateCheck.checked) {
                            btn.classList.add('active');
                            btn.classList.remove(`btn-outline-${btn.classList.contains('btn-outline-primary') ? 'primary' : 
                                                          btn.classList.contains('btn-outline-success') ? 'success' : 
                                                          btn.classList.contains('btn-outline-warning') ? 'warning' : 'info'}`);
                            btn.classList.add(btn.classList.contains('btn-outline-primary') ? 'btn-primary' : 
                                             btn.classList.contains('btn-outline-success') ? 'btn-success' : 
                                             btn.classList.contains('btn-outline-warning') ? 'btn-warning' : 'btn-info');
                        }
                    });
                    updateItemSharing(row);
                });
                showToast('All items assigned to active roommates', 'success');
                updateRoommateTotals();
            });

            document.getElementById('clear-assignments-btn').addEventListener('click', function() {
                document.querySelectorAll('.roommate-btn').forEach(btn => {
                    btn.classList.remove('active');
                    btn.classList.remove(`btn-${btn.classList.contains('btn-primary') ? 'primary' : 
                                            btn.classList.contains('btn-success') ? 'success' : 
                                            btn.classList.contains('btn-warning') ? 'warning' : 'info'}`);
                    btn.classList.add(btn.classList.contains('btn-primary') ? 'btn-outline-primary' : 
                                     btn.classList.contains('btn-success') ? 'btn-outline-success' : 
                                     btn.classList.contains('btn-warning') ? 'btn-outline-warning' : 'btn-outline-info');
                });
                document.querySelectorAll('.item-row').forEach(row => {
                    updateItemSharing(row);
                });
                showToast('All assignments cleared', 'info');
                updateRoommateTotals();
            });
        });

        // Global variables
        let currentDistributionId = null;

        // Share functionality
        function copyShareLink() {
            const shareLink = document.getElementById('share-link');
            shareLink.select();
            document.execCommand('copy');
            
            // Show feedback
            const copyBtn = shareLink.nextElementSibling;
            const originalHtml = copyBtn.innerHTML;
            copyBtn.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => {
                copyBtn.innerHTML = originalHtml;
            }, 2000);
        }

        // Share button click handler
        document.getElementById('share-btn').addEventListener('click', function() {
            const shareLink = document.getElementById('share-link');
            const shareUrl = `${window.location.origin}/share/${currentDistributionId}`;
            shareLink.value = shareUrl;
            new bootstrap.Modal(document.getElementById('shareModal')).show();
        });

        // Handle shared distributions on page load
        document.addEventListener('DOMContentLoaded', function() {
            {% if shared_distribution %}
            // If we have a shared distribution, load it
            const sharedData = {{ shared_distribution|tojson|safe }};
            currentDistributionId = sharedData.distribution_id;
            
            // Populate the form with shared data
            const distributionData = sharedData.distribution_data;
            
            // Clear existing users and items
            document.getElementById('users-container').innerHTML = '';
            document.getElementById('items-container').innerHTML = '';
            
            // Add users
            distributionData.users.forEach(function(user) {
                addUser(user.name, user.id);
            });
            
            // Add items
            distributionData.items.forEach(function(item) {
                addItem(item.name, item.price, item.users);
            });
            
            // Update totals
            updateTotals();
            
            // Show save and share buttons
            document.getElementById('save-btn').style.display = 'inline-block';
            document.getElementById('share-btn').style.display = 'inline-block';
            {% endif %}
        });

        // Save distribution function
        async function saveDistribution() {
            const distributionData = {
                users: getUsers(),
                items: getItems(),
                total: calculateTotal()
            };
            
            try {
                const response = await fetch('/api/save_distribution', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(distributionData)
                });
                
                const result = await response.json();
                if (result.success) {
                    currentDistributionId = result.distribution_id;
                    showToast('Distribution saved successfully! You can now share it with your roommates.', 'success');
                    document.getElementById('share-btn').style.display = 'inline-block';
                } else {
                    showToast('Failed to save distribution: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Error saving distribution: ' + error.message, 'error');
            }
        }

        // Add these sharing functions
        function shareViaWhatsApp() {
            const shareLink = document.getElementById('share-link').value;
            const text = `Check out our receipt split: ${shareLink}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        function shareViaEmail() {
            const shareLink = document.getElementById('share-link').value;
            const subject = 'Receipt Split';
            const body = `Check out our receipt split: ${shareLink}`;
            window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`, '_blank');
        }

        function shareViaTelegram() {
            const shareLink = document.getElementById('share-link').value;
            const text = `Check out our receipt split: ${shareLink}`;
            window.open(`https://t.me/share/url?url=${encodeURIComponent(shareLink)}&text=${encodeURIComponent(text)}`, '_blank');
        }

        // Update the saveDistribution function to show the share button
        async function saveDistribution() {
            const distributionData = {
                users: getUsers(),
                items: getItems(),
                total: calculateTotal()
            };
            
            try {
                const response = await fetch('/api/save_distribution', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(distributionData)
                });
                
                const result = await response.json();
                if (result.success) {
                    currentDistributionId = result.distribution_id;
                    showToast('Distribution saved successfully! You can now share it with your roommates.', 'success');
                    document.getElementById('share-btn').style.display = 'inline-block';
                } else {
                    showToast('Failed to save distribution: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Error saving distribution: ' + error.message, 'error');
            }
        }

        // Add this to your existing JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            // Show save button after successful parsing
            const saveBtn = document.getElementById('save-btn');
            const shareBtn = document.getElementById('share-btn');
            
            // Add click handler for save button
            saveBtn.addEventListener('click', async function() {
                await saveDistribution();
            });
            
            // Add click handler for share button
            shareBtn.addEventListener('click', function() {
                if (!currentDistributionId) {
                    showToast('Please save the distribution first', 'warning');
                    return;
                }
                const shareLink = document.getElementById('share-link');
                const shareUrl = `${window.location.origin}/share/${currentDistributionId}`;
                shareLink.value = shareUrl;
                new bootstrap.Modal(document.getElementById('shareModal')).show();
            });
        });

        // Update the parseReceipt function to show the save button
        async function parseReceipt() {
            // ... existing parse code ...
            
            try {
                const response = await fetch('/api/upload_pdf', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                if (data) {
                    // Show the save button after successful parsing
                    document.getElementById('save-btn').style.display = 'inline-block';
                    // ... rest of your existing code ...
                }
            } catch (error) {
                console.error('Error parsing receipt:', error);
                showError(error.message || 'An error occurred while parsing the receipt');
            }
        }

        // Update the saveDistribution function
        async function saveDistribution() {
            const distributionData = {
                users: getUsers(),
                items: getItems(),
                total: calculateTotal()
            };
            
            try {
                const response = await fetch('/api/save_distribution', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(distributionData)
                });
                
                const result = await response.json();
                if (result.success) {
                    currentDistributionId = result.distribution_id;
                    showToast('Distribution saved successfully! You can now share it with your roommates.', 'success');
                    document.getElementById('share-btn').style.display = 'inline-block';
                } else {
                    showToast('Failed to save distribution: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Error saving distribution: ' + error.message, 'error');
            }
        }
    </script>

    <!-- Add this before the closing </body> tag -->
    <div class="modal fade" id="shareModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Share Receipt</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">Share this link with your roommates so they can assign items and split costs:</p>
                    <div class="input-group mb-3">
                        <input type="text" id="share-link" class="form-control" readonly>
                        <button class="btn btn-outline-primary" onclick="copyShareLink()">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <div class="d-flex gap-2 justify-content-center">
                        <button class="btn btn-outline-primary" onclick="shareViaWhatsApp()">
                            <i class="fab fa-whatsapp me-2"></i>WhatsApp
                        </button>
                        <button class="btn btn-outline-primary" onclick="shareViaEmail()">
                            <i class="fas fa-envelope me-2"></i>Email
                        </button>
                        <button class="btn btn-outline-primary" onclick="shareViaTelegram()">
                            <i class="fab fa-telegram me-2"></i>Telegram
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>